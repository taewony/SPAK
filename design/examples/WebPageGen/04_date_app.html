<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DateApp</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        border-bottom: 2px solid #324fff;
        padding-bottom: 10px;
        margin-top: 0;
      }

      .date-picker {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      input[type="date"] {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        margin-right: 10px;
      }

      button {
        padding: 10px 20px;
        background-color: #324fff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #2a40e0;
      }

      .date-display-container {
        margin: 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        text-align: center;
      }

      .date-field {
        display: inline-block;
        padding: 15px 25px;
        background-color: white;
        border-radius: 8px;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s;
      }

      /* ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ */
      @keyframes dateUpdate {
        0% {
          background-color: #fff;
        }
        50% {
          background-color: #324fff;
        }
        100% {
          background-color: #fff;
        }
      }

      .date-animate {
        animation: dateUpdate 1s ease-in-out;
      }

      .history-log {
        margin-top: 30px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 8px;
        font-size: 14px;
      }

      .history-log h3 {
        margin-top: 0;
        color: #666;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid #ddd;
        font-family: monospace;
      }

      .instructions {
        background: #e8f4ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #324fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“… DateApp</h1>

      <div class="instructions">
        <p>ì´ ì•±ì€ DSL(DateApp)ì„ HTML/CSS/JavaScriptë¡œ êµ¬í˜„í•œ ì˜ˆì œì…ë‹ˆë‹¤.</p>
        <p>
          ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜ "Choose Today" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ DateDisplay
          ì»´í¬ë„ŒíŠ¸ê°€ ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
        </p>
      </div>

      <!-- MyElement ì»´í¬ë„ŒíŠ¸ -->
      <div id="my-element" class="date-picker">
        <h2>MyElement ì»´í¬ë„ŒíŠ¸</h2>

        <div class="input-group">
          <p><strong>Choose a date:</strong></p>
          <input type="date" id="date-input" />
          <button id="today-btn">Choose Today</button>
        </div>

        <div class="status">
          <p><strong>Date chosen:</strong></p>
        </div>

        <!-- DateDisplay ì»´í¬ë„ŒíŠ¸ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        <div id="date-display-container" class="date-display-container">
          <span id="date-field" class="date-field">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        </div>
      </div>

      <div class="history-log">
        <h3>ğŸ“ ìƒíƒœ ë³€ê²½ ë¡œê·¸</h3>
        <div id="log-entries"></div>
      </div>

      <div
        style="
          margin-top: 30px;
          font-size: 12px;
          color: #666;
          text-align: center;
        "
      >
        <p>DSL ì›ë³¸ ì½”ë“œ:</p>
        <pre
          style="
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            text-align: left;
          "
        >
app DateApp {
  component DateDisplay {
    state date : Date
    template: span #datefield { text date.toLocaleDateString() }
    on update(date): animate #datefield frames [
      {bg:"#fff"}, {bg:"#324fff"}, {bg:"#fff"}
    ] duration 1000
  }

  component MyElement {
    state date : Date
    template:
      p { "Choose a date:" input type="date" on change -> dateChanged }
      p { button on click -> chooseToday { "Choose Today" } }
      p { "Date chosen:" DateDisplay bind date }
    transition dateChanged(e):
      let utc = e.target.valueAsDate
      if utc != null: date = localDateFromUTC(utc)
    transition chooseToday: date = now()
  }

  page index {
    head: style body { font-family: sans-serif }
    body: MyElement
  }
}</pre
        >
      </div>
    </div>

    <script>
      // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (utils) ==========
      const DateAppUtils = {
        /**
         * ë‘ ë‚ ì§œê°€ ê°™ì€ ë‚ ì§œì¸ì§€ í™•ì¸ (ì‹œê°„ì€ ë¬´ì‹œ)
         * @param {Date} d1 - ì²« ë²ˆì§¸ ë‚ ì§œ
         * @param {Date} d2 - ë‘ ë²ˆì§¸ ë‚ ì§œ
         * @returns {boolean} ê°™ì€ ë‚ ì§œì´ë©´ true
         */
        isSameDate: function (d1, d2) {
          if (!d1 || !d2) return false;
          return d1.toLocaleDateString() === d2.toLocaleDateString();
        },

        /**
         * UTC ë‚ ì§œ ê°ì²´ë¥¼ ë¡œì»¬ ë‚ ì§œë¡œ ë³€í™˜
         * @param {Date} utc - UTC ë‚ ì§œ ê°ì²´
         * @returns {Date} ë¡œì»¬ ë‚ ì§œ ê°ì²´
         */
        localDateFromUTC: function (utc) {
          if (!utc) return null;
          return new Date(
            utc.getUTCFullYear(),
            utc.getUTCMonth(),
            utc.getUTCDate(),
          );
        },

        /**
         * í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ë°˜í™˜
         * @returns {Date} í˜„ì¬ ë‚ ì§œ
         */
        now: function () {
          return new Date();
        },

        /**
         * ë¡œê·¸ ì¶”ê°€
         * @param {string} message - ë¡œê·¸ ë©”ì‹œì§€
         */
        addLog: function (message) {
          const logContainer = document.getElementById("log-entries");
          const logEntry = document.createElement("div");
          logEntry.className = "log-entry";

          const timestamp = new Date().toLocaleTimeString();
          logEntry.textContent = `[${timestamp}] ${message}`;

          // ìµœì‹  ë¡œê·¸ë¥¼ ìœ„ì— ì¶”ê°€
          if (logContainer.firstChild) {
            logContainer.insertBefore(logEntry, logContainer.firstChild);
          } else {
            logContainer.appendChild(logEntry);
          }

          // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ë¡œê·¸ ì œê±°
          const maxLogs = 10;
          while (logContainer.children.length > maxLogs) {
            logContainer.removeChild(logContainer.lastChild);
          }
        },
      };

      // ========== DateDisplay ì»´í¬ë„ŒíŠ¸ ==========
      class DateDisplay {
        constructor(elementId) {
          this.id = elementId;
          this.date = null;
          this.oldDate = null;
          this.element = document.getElementById(elementId);

          DateAppUtils.addLog(
            `DateDisplay ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”ë¨ (ID: ${elementId})`,
          );
        }

        /**
         * ë‚ ì§œ ì—…ë°ì´íŠ¸
         * @param {Date} newDate - ìƒˆë¡œìš´ ë‚ ì§œ
         */
        setDate(newDate) {
          // invariant: ë‚ ì§œê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ë Œë”ë§
          if (DateAppUtils.isSameDate(this.date, newDate)) {
            return;
          }

          this.oldDate = this.date;
          this.date = newDate;

          this.render();
          this.animate();

          DateAppUtils.addLog(
            `DateDisplay ì—…ë°ì´íŠ¸: ${newDate ? newDate.toLocaleDateString() : "null"}`,
          );
        }

        /**
         * ë Œë”ë§
         */
        render() {
          if (!this.element) return;

          if (this.date) {
            this.element.textContent = this.date.toLocaleDateString();
          } else {
            this.element.textContent = "ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”";
          }
        }

        /**
         * ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (DSLì˜ on update êµ¬í˜„)
         */
        animate() {
          if (!this.element) return;

          // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°
          this.element.classList.remove("date-animate");

          // ë¦¬í”Œë¡œìš° ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘)
          void this.element.offsetWidth;

          // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì¶”ê°€
          this.element.classList.add("date-animate");

          DateAppUtils.addLog("DateDisplay ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ë¨");

          // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ í´ë˜ìŠ¤ ì œê±°
          setTimeout(() => {
            this.element.classList.remove("date-animate");
          }, 1000);
        }

        /**
         * í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
         * @returns {Date} í˜„ì¬ ë‚ ì§œ
         */
        getDate() {
          return this.date;
        }
      }

      // ========== MyElement ì»´í¬ë„ŒíŠ¸ ==========
      class MyElement {
        constructor() {
          this.date = null;
          this.dateDisplay = new DateDisplay("date-field");

          this.initializeElements();
          this.bindEvents();

          DateAppUtils.addLog("MyElement ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”ë¨");
        }

        /**
         * DOM ìš”ì†Œ ì´ˆê¸°í™”
         */
        initializeElements() {
          this.dateInput = document.getElementById("date-input");
          this.todayBtn = document.getElementById("today-btn");

          // ë‚ ì§œ ì…ë ¥ í•„ë“œì— ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
          const today = new Date();
          const todayString = today.toISOString().split("T")[0];
          this.dateInput.value = todayString;

          // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
          this.setDate(today);
        }

        /**
         * ì´ë²¤íŠ¸ ë°”ì¸ë”© (DSLì˜ transition êµ¬í˜„)
         */
        bindEvents() {
          // ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸ (DSLì˜ dateChanged transition)
          this.dateInput.addEventListener("change", (e) => {
            const utc = e.target.valueAsDate;
            if (utc !== null) {
              const localDate = DateAppUtils.localDateFromUTC(utc);
              this.setDate(localDate);
              DateAppUtils.addLog(
                `ë‚ ì§œ ë³€ê²½ë¨: ${localDate.toLocaleDateString()}`,
              );
            }
          });

          // ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ (DSLì˜ chooseToday transition)
          this.todayBtn.addEventListener("click", () => {
            const today = DateAppUtils.now();
            this.setDate(today);

            // ì…ë ¥ í•„ë“œë„ ì—…ë°ì´íŠ¸
            const todayString = today.toISOString().split("T")[0];
            this.dateInput.value = todayString;

            DateAppUtils.addLog(
              `ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ: ${today.toLocaleDateString()}`,
            );
          });
        }

        /**
         * ë‚ ì§œ ì„¤ì •
         * @param {Date} newDate - ìƒˆë¡œìš´ ë‚ ì§œ
         */
        setDate(newDate) {
          this.date = newDate;

          // DateDisplayì— ë‚ ì§œ ì „ë‹¬ (DSLì˜ bind êµ¬í˜„)
          this.dateDisplay.setDate(newDate);
        }

        /**
         * í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
         * @returns {Date} í˜„ì¬ ë‚ ì§œ
         */
        getDate() {
          return this.date;
        }
      }

      // ========== ì•± ì´ˆê¸°í™” ==========
      document.addEventListener("DOMContentLoaded", () => {
        DateAppUtils.addLog("DateApp ì‹œì‘ë¨");

        // MyElement ì»´í¬ë„ŒíŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const myElement = new MyElement();

        // ì „ì—­ ê°ì²´ë¡œ ë…¸ì¶œ (ê°œë°œì ë„êµ¬ì—ì„œ í…ŒìŠ¤íŠ¸ìš©)
        window.DateApp = {
          utils: DateAppUtils,
          components: {
            myElement: myElement,
            dateDisplay: myElement.dateDisplay,
          },
          getCurrentDate: () => myElement.getDate(),
        };

        DateAppUtils.addLog("DateApp ì´ˆê¸°í™” ì™„ë£Œ");
        console.log(
          "DateAppì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. window.DateApp ê°ì²´ë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        );
      });

      // ========== ì¶”ê°€ ê¸°ëŠ¥: ìƒíƒœ ê´€ì°°ì ==========
      // ìƒíƒœ ë³€ê²½ì„ ê°ì§€í•˜ëŠ” ê°„ë‹¨í•œ ì˜µì €ë²„ íŒ¨í„´ êµ¬í˜„
      class StateObserver {
        constructor() {
          this.observers = [];
        }

        subscribe(callback) {
          this.observers.push(callback);
        }

        notify(data) {
          this.observers.forEach((observer) => observer(data));
        }
      }

      // ì „ì—­ ìƒíƒœ ê´€ì°°ì ìƒì„±
      window.dateStateObserver = new StateObserver();

      // ìƒíƒœ ë³€ê²½ ì‹œ ë¡œê¹…
      window.dateStateObserver.subscribe((newDate) => {
        console.log("ìƒíƒœ ë³€ê²½ ê°ì§€:", newDate.toLocaleDateString());
      });
    </script>
  </body>
</html>
