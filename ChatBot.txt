meta {
  name        = "PersonaChatBot"
  version     = "1.0"
  level       = "L1-Conversational"
  description = "A minimal persona-driven conversational agent using local LLM only"
}

agent PersonaChatBot {

  role = "Persona-based conversational responder"

  ############################
  # State
  ############################

  state ChatState {
    persona: String
    conversation_history: List[String]
    last_user_input: String
    last_response: String
  }

  ############################
  # Effects
  ############################

  effect LocalLLM {
    operation generate(prompt: String) -> String
  }

  effect Memory {
    operation append(entry: String)
    operation read() -> List[String]
    operation clear()
  }

  ############################
  # Lifecycle
  ############################

  init {
    persona = "neutral and helpful assistant"
    conversation_history = []
  }

  ############################
  # Cognitive Phases
  ############################

  phase Think {
    description = "Interpret user input under persona constraints"

    function analyze(user_input: String) -> String {
      return """
      Persona: ${persona}
      Conversation so far:
      ${Memory.read()}

      User says:
      ${user_input}

      Interpret intent and appropriate tone under the persona.
      """
    }
  }

  phase Respond {
    description = "Generate persona-consistent reply"

    function reply(thought_prompt: String) -> String {
      perform LocalLLM.generate(thought_prompt)
    }
  }

  phase Reflect {
    description = "Update memory only (no strategy update)"

    function update_memory(user_input: String, response: String) -> Void {
      perform Memory.append("User: " + user_input)
      perform Memory.append("Agent: " + response)
    }
  }

  ############################
  # Main Interaction Loop
  ############################

  workflow ChatTurn(user_input: String) -> String {

    step ThinkStep {
      thought_prompt = Think.analyze(user_input)
    }

    step RespondStep {
      response = Respond.reply(thought_prompt)
    }

    step ReflectStep {
      Reflect.update_memory(user_input, response)
    }

    output response
  }

  ############################
  # Persona Control
  ############################

  function set_persona(new_persona: String) -> String {
    persona = new_persona
    perform Memory.clear()
    return "Persona updated and conversation history reset."
  }

  ############################
  # Success Criteria
  ############################

  success_criteria = [
    "Persona consistency across turns",
    "Conversation coherence",
    "No planning or goal-directed behavior"
  ]

}
